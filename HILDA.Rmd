---
output:
  html_document:
    keep_md: yes
---
```{r set-options, echo=F, cache=F}
options(width = 120)
```

```{r load-libraries, echo=F, cache=F}
library(mgcv)
library(ordinal)
```

# HILDA

Le variabili di Interesse sono edhigh1 (education) e jbmo62 (occupation). 
Come vedi ci sono relativamente pochi immigrati. 
Ti ho inviato un'extraction del pannello (xwaveid e wave). Ci sono 12 osservazioni al massimo ma come vedrai non per tutti.
I salari sono wscei (current weekly wage) e wsfei (Financial year wage) 

Covariates:
ancob: Country of birth
yrivwfst: year first interview
yrivwlst: year last interview
hh*: household...
edcqtyp: Currently studying full or part time
esdtl: Labour force status - detail
esempst: Current employment status
jb*: job... (jbmo62)
helth: Long term health condition
fmfsch: How much schooling father completed
fmmsch: How much schooling mother completed
anlote: Speak language other than English
aneab: How well speaks English
anyoa: Year first came to Australia to live (no anyoan)
anpappn: Australian visa - Primary applicant
anengfn: Is English the first language you learned to speak as a child
edcoqn: Country completed highest education
rtcompn: Retired completely from the workforce
rtyrn: Year retired
jbmoccs: occupational status scale, current main job
tcr: Number of own resident children
tcnr: Number of own non-resident children
hhyng: Age of youngest person in household
hhold: Age of oldest person in household
anmigc: Migration category when you or your family first arrived in Australia: **mostly missings**
fmnsib: How many siblings
edqenr: Ever enrolled in a course of study to obtain a qualification
edcoq: Country completed highest qualification
hgage: Age last birthday at June 30 2012
ehtse: Time since FT (full-time) education - years
## Data

* Load the data and make some home cleaning (details omitted).
```{r data_manipulation, eval=T, include=T, echo=F, comment=NA, cache=F}
#library(readstata13)
setwd("~/Dropbox/Attachments/-.Migrations/data")
load("Hilda.RData")
#x=read.dta13("MAURIZIO_HILDA_extraction.dta")
x <- x[which(substr(x$jbmo62, 2,2)!="-"),] #Delete people without info on job
x = x[x$yrivwfst!=-2,]
x$age_at_interview = x$hgage - (2012-x$yrivwfst)

x$anmigc = as.factor(x$anmigc)

# ancob [country of birth] --> 3 categories: AU, anglo, others
missings.ancob=which(as.numeric(x$ancob) <=10)
x = x[-missings.ancob,]
au = c("[1101] Australia")
anglo = c("[2100] United Kingdom", "[2201] Ireland", "[9225] South Africa", "[8102] Canada", "[8104] United States of America")
i.au = which(x$ancob %in% au)
i.anglo = which(x$ancob %in% anglo)
ancob3 = rep("imm_others", nrow(x)) 
ancob3[i.au] = "australians"
ancob3[i.anglo] = "imm_anglo"
x$ancob3 = factor(ancob3)

x$edcoq[is.na(x$edcoq)] = 1 #<----- check
x$edqenr[is.na(x$edqenr)] = 1 #<----- check
x$aneab[i.au] = 1

# anyoa [year of arriva] --> wave-age for non-migrants
x$anyoa[i.au] = 2012 - x$hgage[i.au]
x=x[x$anyoa>1900,]
#WARNNING: i.au no more valid from here on
##Factors##
facto <- c("xwaveid","edcoq")
for (f in facto) x[,f]=factor(x[,f])
##Ordered factors##
facto <- c("jbmspay","jbmssec")
for (f in facto) x[,f]=factor(x[,f], ordered=T)
x$wsfei[x$wsfei==0] = 1
x$dob <- 2012 - x$hgage
x$age <- x$yrivwfst -x$dob - 1 + x$wave
x$ehtse_au = x$ehtse_anglo = x$ehtse_others = 0
x$ehtse_au[x$ancob3=="australians"] = x$ehtse[x$ancob3=="australians"]
x$ehtse_anglo[x$ancob3=="imm_anglo"] = x$ehtse[x$ancob3=="imm_anglo"]
x$ehtse_others[x$ancob3=="imm_others"] = x$ehtse[x$ancob3=="imm_others"]
####
#wave stratified by age groups (<=40hrs, >40hrs)
age_limits = c(15,25,35,45,55)
age_category = findInterval(x$hgage, age_limits)
x$wave_age1 = x$wave_age2 = x$wave_age3 = x$wave_age4 = x$wave_age5 = 0
x$wave_age1[which(age_category == 1)] = x$wave[which(age_category == 1)] 
x$wave_age2[which(age_category == 2)] = x$wave[which(age_category == 2)] 
x$wave_age3[which(age_category == 3)] = x$wave[which(age_category == 3)] 
x$wave_age4[which(age_category == 4)] = x$wave[which(age_category == 4)] 
x$wave_age5[which(age_category == 5)] = x$wave[which(age_category == 5)] 
#wave stratified by migration status (Australians vs English speaking migrants vs other migrants)
x$wave_au = x$wave_anglo = x$wave_others = 0
x$wave_au[x$ancob3=="australians"] = x$wave[x$ancob3=="australians"] 
x$wave_anglo[x$ancob3=="imm_anglo"] = x$wave[x$ancob3=="imm_anglo"] 
x$wave_others[x$ancob3=="imm_others"] = x$wave[x$ancob3=="imm_others"] 
#wave stratified by education
x$wave_ed1 = x$wave_ed2 = x$wave_ed3 = x$wave_ed4 = x$wave_ed5 = x$wave_ed6 = x$wave_ed7 = x$wave_ed8 = 0
ed_lev = levels(droplevels(x$edhigh1))
x$wave_ed1[x$edhigh1==ed_lev[1]] = x$wave[x$edhigh1==ed_lev[1]] 
x$wave_ed2[x$edhigh1==ed_lev[2]] = x$wave[x$edhigh1==ed_lev[2]] 
x$wave_ed3[x$edhigh1==ed_lev[3]] = x$wave[x$edhigh1==ed_lev[3]] 
x$wave_ed4[x$edhigh1==ed_lev[4]] = x$wave[x$edhigh1==ed_lev[4]] 
x$wave_ed5[x$edhigh1==ed_lev[5]] = x$wave[x$edhigh1==ed_lev[5]] 
x$wave_ed6[x$edhigh1==ed_lev[6]] = x$wave[x$edhigh1==ed_lev[6]] 
x$wave_ed7[x$edhigh1==ed_lev[7]] = x$wave[x$edhigh1==ed_lev[7]] 
x$wave_ed8[x$edhigh1==ed_lev[8]] = x$wave[x$edhigh1==ed_lev[8]] 
#wave stratified by skilled jobs (3 categories)
x$wave_skill1 = x$wave_skill2 = x$wave_skill3 = 0
skill_limits = c(1,4,7)
skill_category = findInterval(as.integer(sapply(x$jbmo62, substr, 2,2)), skill_limits)
x$wave_skill1[which(skill_category==1)] = x$wave[which(skill_category==1)] 
x$wave_skill2[which(skill_category==2)] = x$wave[which(skill_category==2)] 
x$wave_skill3[which(skill_category==3)] = x$wave[which(skill_category==3)] 
##
## CLEANING
##
x <- x[x$jbhru<900,] # take away who works 997 hours per week (~3500 records)
x <- x[x$wsfei>10000,] #try only with records where the salary is greater than 10000

```

* Create the variable wages_perc: percentile of salary specific to each job [details omitted].
```{r wages_perc, eval=T, include=T, echo=F, comment=NA, cache=F}
##wages_perc
individual_quantiles <- function(x){
	n <- length(x)
	return(rank(x)/n)
}

perc_by_job =by(x, x$jbmo62, function(x)quantile(x$wsfei, prob=c(0,.1,.2,.3,.4,.5,.6,.7,.8,.9,1)))
jobs=levels(x$jbmo62)
jobs=jobs[substr(jobs,1,2)!="[-"]
x$wages_perc = rep(NA, nrow(x))
for (j in jobs){
	ii <- which(x$jbmo62 == j)
	wages <- x[ii,"wsfei"]
	wages_perc <- individual_quantiles(wages)
	x[ii,"wages_perc"] <- wages_perc
}
x=x[!is.na(x$wages_perc),]
```

## Models suggested by Max:

1. wage = costant + demographics + experience(age-anni scuola) + caract.employer(if available) + location + e
2. participation (0=no,1=yes) = costant + demographics + education + young children + wealth + e

### Variables

* wscei: weekly wage ---> replaced with wsfei (annual wage)
~
* ancob  [immigrato o no] --> replaced with ancob3: 3 categories: au, anglo, others
* edcoq  [education in au]
* edqenr [qualifica in au]
* fmfo61 and/or fmmo61 [figlio di operai]
...controlli...
* aneab [conoscenze inglese: missings born in au replaced with 1:very well]
* anyoa [year of arrival]. For non-migrants, replace with 2012-age_2012
* edagels o edhigh1 [years of education] ---> used edhigh1
* esdtl [participation to labour market]
* hgage [age]
* hgsex [sex]
* marital status [mrcurr]
* hhmsr o hhstate [location]
* jbmo62 [occupation]
* jbmwpsz [no employees]
* jbocct [tenure current job]
* ehtse [years since studying FT]

### Analyses 

In fit26, we fit the number of hours worked against several covs.
In the next analyses, we will fit identical models with different dependent variables: 
1. fit27: wsfei (annual salary); 
2. fit27weekly: wscei (weekly salary); 
3. fit27hrwage: hrw (hourly salary) 
4. fit28: wage_perc (the annual salary is transformed into the percentile specific to the subject's occupation).
5. In the third fit (fit29), we add the random effects over the subjects (the fit fails when using the annual salary as dependent variable, but succesfully converge with wages_perc).

```{r fit26, eval=T, include=T, echo=T, comment=NA, cache=F}
model26=(jbhru ~ s(wave) +  s(hgage) + sex + ancob3 + edhigh1 + jbmo62 + edcoq + edqenr + fmfo61 + fmmo61 + esdtl + mrcurr + hhstate + jbmwpsz + jbocct + aneab)
fit26 = gam(model26, data=x)
anova(fit26)
plot(fit26,pages=1, scale=-1, rug=F)
```

There is no indication of any effect of the global crisis on the number of hours worked per week.

```{r fit27, eval=T, include=T, echo=T, comment=NA, cache=F}
model27=(log(wsfei) ~ s(wave) +  s(hgage) + sex + ancob3 + edhigh1 + jbmo62 + edcoq + edqenr + fmfo61 + fmmo61 + esdtl + mrcurr + hhstate + jbmwpsz + jbocct + aneab)
fit27 = gam(model27, data=x)
anova(fit27)
plot(fit27,pages=1, scale=-1, rug=F)
```

```{r fit27bis, eval=T, include=T, echo=T, comment=NA, cache=F}
model27bis=(log(wsfei) ~ s(wave) +  s(hgage) + sex + ancob3 + edhigh1 + jbmo62 + edcoq + edqenr + fmfo61 + fmmo61 + esdtl + mrcurr + hhstate + jbmwpsz + jbocct + aneab + jbhru)
fit27bis = gam(model27bis, data=x)
anova(fit27bis)
plot(fit27bis,pages=1, scale=-1, rug=F)
```

In fit27bis we repeat the same regression as in fit27, but consider the weekly worked hours as a covariate (significant). The effect of wave over the salary is similar as in fit27.

```{r fit27weekly, eval=T, include=T, echo=T, comment=NA, cache=F}
x2=x[x$wscei>0 & x$jbhru>0,]
x2$wpw = x2$wscei/x2$jbhru
model27weekly=(log(wscei) ~ s(wave) +  s(hgage) + sex + ancob3 + edhigh1 + jbmo62 + edcoq + edqenr + fmfo61 + fmmo61 + esdtl + mrcurr + hhstate + jbmwpsz + jbocct + aneab)
fit27weekly = gam(model27weekly, data=x2)
anova(fit27weekly)
plot(fit27weekly,pages=1, scale=-1, rug=F)
```

The global crisis effect is not as strong as using the annual salary as the dependent variable.

```{r fit27hrwage, eval=T, include=T, echo=T, comment=NA, cache=F}
x2=x[x$wscei>0 & x$jbhru>0,]
x2$hrw = x2$wscei/x2$jbhru
model27hrwage=(hrw ~ s(wave) +  s(hgage) + sex + ancob3 + edhigh1 + jbmo62 + edcoq + edqenr + fmfo61 + fmmo61 + esdtl + mrcurr + hhstate + jbmwpsz + jbocct + aneab)
fit27hrwage = gam(model27hrwage, data=x2)
anova(fit27hrwage)
plot(fit27hrwage,pages=1, scale=-1, rug=F)
```

There has been a slower increase of the hourly wage as an effect of the global crisis. This has nothing to do with the status of native or migrant (ancob3) or the knowledge of English (aneab)



```{r fit28, eval=T, include=T, echo=T, comment=NA, cache=F}
model28=(wages_perc ~ s(wave) +  s(hgage) + sex + ancob3 + edhigh1 + jbmo62 + edcoq + edqenr + fmfo61 + fmmo61 + esdtl + mrcurr + hhstate + jbmwpsz + jbocct + aneab)
fit28 = gam(model28, data=x)
anova(fit28)
plot(fit28,pages=1, scale=-1, rug=F)
```

```{r fit29, eval=T, include=T, echo=F, comment=NA}
load("fit29.RData")
#fit29 = gamm(model28, random=list(xwaveid=~1), data=x)
#summary(fit29$lme)
anova(fit29$gam)
plot(fit29$gam,pages=1)

#Males vs females
#xm=x[x$sex=="[1] Male",]
#xf=x[x$sex=="[2] Female",]
#model26m=(wsfei ~ s(wave) +  s(hgage) + s(anyoa) + ancob3 + edhigh1 + jbmo62 + edcoq + edqenr + fmfo61 + fmmo61 + esdtl + mrcurr + hhstate + jbmwpsz + jbocct + aneab)
#fit26m = gam(model26m, data=xm)
#anova(fit26m)
#plot(fit26m,pages=1)
#model26f=(wsfei ~ s(wave) +  s(hgage) + s(anyoa) + ancob3 + edhigh1 + jbmo62 + edcoq + edqenr + fmfo61 + fmmo61 + esdtl + mrcurr + hhstate + #jbmwpsz + jbocct + aneab)
#fit26f = gam(model26f, data=xf)
#anova(fit26f)
#plot(fit26f,pages=1)
```

The last fit (fit29) shows that the effect on the wave can be assumed linear and a few covariates are no more significant and can be eliminated from the model. These are:

* Occupation of parents
* ancob3: australian, migrant anglo, migrant other.

This result can be interpreted considering that the dependent variable is the salary percentile of the subject specific to his job. The occupation of the parents and the status of migrant could contribute to choice of the job, but not to the salary in it (hypothesis to test).

## fit27: wave stratified by age groups

```{r fit27byAge, eval=T, include=T, echo=T, comment=NA, cache=F}
model27byAge=(log(wsfei) ~ s(wave_age1) + s(wave_age2) + s(wave_age3) + s(wave_age4) + s(wave_age5) +  s(hgage) + sex + ancob3 + edhigh1 + jbmo62 + edcoq + edqenr + fmfo61 + fmmo61 + esdtl + mrcurr + hhstate + jbmwpsz + jbocct + aneab)
fit27byAge = gam(model27byAge, data=x)
anova(fit27byAge)
plot(fit27byAge,pages=1, scale=-1, rug=F)
```

The effect of the global crisis has been similar in all the 5 age groups.

## fit27bis: wave stratified by age groups (<=40hrs, >40hrs)

```{r fit27byAgeLessThan40, eval=T, include=T, echo=T, comment=NA, cache=F}
x2 <- x[x$jbhru<=40,]
#x3 <- x[x$jbhru>40,]

model27byAge=(log(wsfei) ~ s(wave_age1) + s(wave_age2) + s(wave_age3) + s(wave_age4) + s(wave_age5) +  s(hgage) + sex + ancob3 + edhigh1 + jbmo62 + edcoq + edqenr + fmfo61 + fmmo61 + esdtl + mrcurr + hhstate + jbmwpsz + jbocct + aneab)
fit27byAge = gam(model27byAge, data=x2)
anova(fit27byAge)
plot(fit27byAge,pages=1, scale=-1, rug=F)
```

The effect of the global crisis has been similar in all the 5 age groups.


## fit27: wave stratified by migration status (Australians vs English speaking migrants vs other migrants)

```{r fit27byMigrationStatus, eval=T, include=T, echo=T, comment=NA, cache=F}
model27byMigrationStatus=(log(wsfei) ~ s(wave_au) + s(wave_anglo) + s(wave_others) + s(hgage) + sex + ancob3 + edhigh1 + jbmo62 + edcoq + edqenr + fmfo61 + fmmo61 + esdtl + mrcurr + hhstate + jbmwpsz + jbocct) # aneab cannot stay in the regression as few unique covariate combinations with wave_*
fit27byMigrationStatus = gam(model27byMigrationStatus, data=x)
anova(fit27byMigrationStatus)
plot(fit27byMigrationStatus,pages=1, scale=-1, rug=F) #all.terms=T
```

No differences in migration status.

## fit27: wave stratified by education

```{r fit27byEducation, eval=T, include=T, echo=T, comment=NA, cache=F}
model27byEducation=(log(wsfei) ~ s(wave_ed1) + s(wave_ed2) + s(wave_ed3) + s(wave_ed4) + s(wave_ed5) + s(wave_ed6) + s(wave_ed7) + s(hgage) + sex + ancob3 + edhigh1 + jbmo62 + edcoq + edqenr + fmfo61 + fmmo61 + esdtl + mrcurr + hhstate + jbmwpsz + jbocct + aneab)
fit27byEducation = gam(model27byEducation, data=x)
anova(fit27byEducation)
plot(fit27byEducation,pages=1, scale=-1, rug=F) #all.terms=T
```

There is a weak effect: the higher the education level, the lighter the effect of the global crisis.

## fit27: wave stratified by skilled jobs (3 categories)

```{r fit27bySkilledJobs, eval=T, include=T, echo=T, comment=NA, cache=F}
model27bySkilledJobs=(log(wsfei) ~ s(x$wave_skill1) + s(x$wave_skill2) + s(x$wave_skill3) + s(hgage) + sex + ancob3 + edhigh1 + jbmo62 + edcoq + edqenr + fmfo61 + fmmo61 + esdtl + mrcurr + hhstate + jbmwpsz + jbocct + aneab)
fit27bySkilledJobs = gam(model27bySkilledJobs, data=x)
anova(fit27bySkilledJobs)
plot(fit27bySkilledJobs,pages=1, scale=-1, rug=F) #all.terms=T
```

No differences in job skill categories.


## More on time-related covariates

Two temporal variables: (check this, something wrong)
* age = yrivwfst-(2012-yrivwfst)-1+wave (changing each year) 
* date of birth (dob=2012-hgage)

```{r consider_age, eval=T, include=T, echo=F, comment=NA, cache=F}
model30=(wages_perc ~ s(dob) + s(age) + sex + ancob3 + edhigh1 + jbmo62 + edcoq + edqenr + fmfo61 + fmmo61 + esdtl + mrcurr + hhstate + jbmwpsz + jbocct + aneab)
fit30 = gam(model30, data=x)
anova(fit30)
plot(fit30,pages=1)

```

Replace the age of subject with the years since studying FT (ehtse). Also, we now restrict the analysis to workers with info on years since last studying.

```{r fit31, eval=T, include=T, echo=F, comment=NA, cache=F}
#x2: workers with info on years since last studying
x2=x[x$ehtse>0 & (as.integer(x$esdtl)==11 | as.integer(x$esdtl)==12 | as.integer(x$esdtl)==17),]
model31=(wages_perc ~ s(ehtse_au) + s(ehtse_anglo) + s(ehtse_others) + sex + ancob3 + edhigh1 + jbmo62 + edcoq + edqenr + fmfo61 + fmmo61 + esdtl + mrcurr + hhstate + jbmwpsz + jbocct + aneab)
fit31 = gam(model31, data=x2)
anova(fit31)
plot(fit31, rug=F ,pages=1)
```

Taking away ancob3 from the regression:

```{r fit32, eval=T, include=T, echo=F, comment=NA}
model32=(wages_perc ~ s(ehtse_au) + s(ehtse_anglo) + s(ehtse_others) + sex + edhigh1 + jbmo62 + edcoq + edqenr + fmfo61 + fmmo61 + esdtl + mrcurr + hhstate + jbmwpsz + jbocct + aneab)
fit32 = gam(model32, data=x2)
anova(fit32)
plot(fit32, rug=F ,pages=1)
```


## Job satisfaction

Guardando alla tua domanda di OSP e cose che potrebbero essere divertenti, la variabile  latente per eccellenza e' la Job satisfaction. Tra quella per i soldi e per sicurezza (jbmssec) mi sembra ci sia piu' variabilita' per Job satisfaction about pay (jbmspay) e potremmo vedere:
 
1. dall'inizio HILDA, quali sono i lavori dove chi lavora e' piu' felice? [jbmo62]
2. ci sono settori che sono sistematicamente over-paid (qui dovresti vedere in primis mining e finanza. Anche il settore pubblico non e' male)
3. sono piu' felici uomi e donne? [sex]
4. immigrati o nativi? [ancob3]
5. giovani o vecchi? (possibile scala: 25-29; 30-39; 40-49; 50-59; 60+) [s(hgage)]
6. laureati o no? [edcoq --> ...]
7. lavoratori fedeli al'employer o switchers? (tenure: jbocct) 
8. in che stato? (hhstate)
9. e in che tipo di famiglia? (hhtype)
 
detto questo, mi sembra che il funzionale che tu stai usando e' legato al tempo: puo' essere usato anche su intensita', tipo prestigio (jbmoccs): il prestigio ha molte categorie ma e' stato surveyed solo in wave 5. Il che vuol dire mappare le occupation/Prestige scale da wave 5 e 'spararla' alle occupations di tutte le rimanenti waves.

#### Satisfaction for job pay

```{r subset, eval=T, include=T, echo=F, comment=NA, cache=F}
xsub=x[,c("xwaveid","hgsex","jbmspay","jbmssec","jbmo62","ancob3","hgage","ehtse","edcoq","jbocct","hhstate","hhtype","wsfei","wages_perc", "ehtse_au","ehtse_anglo","ehtse_others")]
xsub <- xsub[substr(as.character(xsub$jbmspay),1,1)!="-" & substr(as.character(xsub$jbmssec),1,1)!="-",]
xsub <- xsub[substr(xsub$hhstate,1,2)!="[-",]
xsub=droplevels(xsub)
```

Comparison of the effects on satisfation by salary vs wages_perc.

##### Salary:
```{r satisfaction_job_pay_salary, eval=T, include=T, echo=F, comment=NA, cache=F}
fit <- clm(jbmspay ~ hgsex + hgage + ancob3+ hhtype+ jbocct + I(log(wsfei)), data=xsub)
summary(fit)
extractAIC(fit)
```

##### wages_perc

```{r satisfaction_job_pay_perc, eval=T, include=T, echo=F, comment=NA, cache=F}
fitp <- clm(jbmspay ~ hgsex + hgage + ancob3+ hhtype+ jbocct + wages_perc, data=xsub)
summary(fitp)
extractAIC(fitp)
#fit <- clm(jbmspay ~ hgsex + jbmo62 + ancob3 + hgage + edcoq + jbocct + hhstate + hhtype + wages_perc, data=xsub)
#summary(fit)
#fitm <- clmm(jbmspay ~ hgsex + jbmo62 + ancob3 + hgage + edcoq + jbocct + hhstate + hhtype + wages_perc + (1|xwaveid), data=xsub)
```

The model fitted with the wager_perc variable is a better choice than that with the annula salary wsfei.


```{r satisfaction_job_pay_perc_interaction, eval=T, include=T, echo=F, comment=NA, cache=F}
fitp2 <- clm(jbmspay ~ hgsex + hgage +  hhtype+ ancob3 + jbocct:ancob3 + wages_perc:ancob3, data=xsub)
summary(fitp2)
extractAIC(fitp2)
```

AIC improved.

```{r satisfaction_job_pay_perc_interaction_rnd, eval=F, include=T, echo=F, comment=NA, cache=F}
fitp2rnd <- clmm(jbmspay ~ hgsex + hgage +  hhtype+ ancob3 + jbocct:ancob3 + wages_perc:ancob3 + (1|xwaveid), data=xsub)
summary(fitp2rnd)
extractAIC(fitp2rnd)
```

##### Smoothing satisfaction pay

```{r libraries-detach-attach, echo=F, cache=F}
detach("package:mgcv")
library(VGAM)
```

We now create three variables: the wage (or wage_perc) for Australians, English-speaking migrants and other migrants.
We fit a generalized additive model with the effect of these three variable smoothed.

```{r vgam1, eval=T, include=T, echo=F, comment=NA}
#fitgam0 <- vgam(jbmspay ~ hgsex + hgage + ancob3+ hhtype+ jbocct + s(wages_perc), data=xsub, family=propodds)
#plotvgam(fitgam0, rugplot=F)

##wage
xsub$w_au = xsub$w_anglo = xsub$w_others = 0
xsub$w_au[xsub$ancob3=="australians"] = xsub$wsfei[xsub$ancob3=="australians"]
xsub$w_anglo[xsub$ancob3=="imm_anglo"] = xsub$wsfei[xsub$ancob3=="imm_anglo"]
xsub$w_others[xsub$ancob3=="imm_others"] = xsub$wsfei[xsub$ancob3=="imm_others"]
fitgam_wage <- vgam(jbmspay ~ hgsex + hgage + hhtype+ jbocct + s(w_au) + s(w_anglo) + s(w_others), data=xsub, family=propodds)
plotvgam(fitgam_wage, se=T, rugplot=F, xlab="wage percentiles", ylab="effect on satisfaction", which.term=c("s(w_au)"),control=plotvgam.control(ylim=c(-.2,.4), lcol="blue", scol="blue"))
plotvgam(fitgam_wage, se=T, rugplot=F, which.term=c("s(w_anglo)"),control=plotvgam.control(add.arg=T, lcol="red", scol="red"))
plotvgam(fitgam_wage, se=T, rugplot=F, which.term=c("s(w_others)"),control=plotvgam.control(add.arg=T, lcol="black", scol="black"))
legend("bottomright",c("Australians", "English-speaking migrants", "Other migrants") , col=c("blue","red","black"), lty=c(1,1,1) )
```

The confidence intervals are too big, the wage is not the right variable to use.
We can now use the percentiles of wage in each job code.

```{r vgam2, eval=T, include=T, echo=F, comment=NA}
##wage_perc
xsub$wp_au = xsub$wp_anglo = xsub$wp_others = 0
xsub$wp_au[xsub$ancob3=="australians"] = xsub$wages_perc[xsub$ancob3=="australians"]
xsub$wp_anglo[xsub$ancob3=="imm_anglo"] = xsub$wages_perc[xsub$ancob3=="imm_anglo"]
xsub$wp_others[xsub$ancob3=="imm_others"] = xsub$wages_perc[xsub$ancob3=="imm_others"]
fitgam <- vgam(jbmspay ~ hgsex + hgage + hhtype+ jbocct + s(wp_au) + s(wp_anglo) + s(wp_others), data=xsub, family=propodds)
plotvgam(fitgam, rugplot=F, se=T, xlab="wage percentiles", ylab="effect on satisfaction", which.term=c("s(wp_au)"),control=plotvgam.control(ylim=c(-.3,.5), lcol="blue", scol="blue"))
plotvgam(fitgam, rugplot=F, se=T, which.term=c("s(wp_anglo)"),control=plotvgam.control(add.arg=T, lcol="red", scol="red"))
plotvgam(fitgam, rugplot=F, se=T, which.term=c("s(wp_others)"),control=plotvgam.control(add.arg=T, lcol="black", scol="black"))
legend("bottomright",c("Australians", "English-speaking migrants", "Other migrants") , col=c("blue","red","black"), lty=c(1,1,1) )
```

The results are interesting: [interpretation here].
Let's now study the satisfaction for pay as function of yearssince studying:

```{r vgam3, eval=T, include=T, echo=F, comment=NA}
fitgam <- vgam(jbmspay ~ hgsex + hgage + hhtype+ jbocct + ancob3 + s(wages_perc) + s(ehtse_au) + s(ehtse_anglo) + s(ehtse_others), data=xsub, family=propodds)
#Wages_perc
plotvgam(fitgam, rugplot=F, se=T, xlab="wage percentiles", ylab="effect on satisfaction", which.term=c("s(wages_perc)"),control=plotvgam.control(ylim=c(-.3,1), lcol="blue", scol="black"))
#Years since studying
plotvgam(fitgam, rugplot=F, se=F, xlab="Years since studying", ylab="effect on satisfaction", which.term=c("s(ehtse_au)"),control=plotvgam.control(ylim=c(-1,1), lcol="blue", scol="blue"))
plotvgam(fitgam, rugplot=F, se=F, which.term=c("s(ehtse_anglo)"),control=plotvgam.control(add.arg=T, lcol="red", scol="red"))
plotvgam(fitgam, rugplot=F, se=F, which.term=c("s(ehtse_others)"),control=plotvgam.control(add.arg=T, lcol="black", scol="black"))
legend("bottomright",c("Australians", "English-speaking migrants", "Other migrants") , col=c("blue","red","black"), lty=c(1,1,1) )
```

There are no differences between Australians, English-speaking migrant and other migrants in the satisfaction for pay as a function of the time since last studying.




#### Satisfaction for job security:

##### Salary:

```{r satisfaction_job_security_salary, eval=T, include=T, echo=F, comment=NA, cache=F}
library(ordinal)
fit <- clm(jbmssec ~ hgsex + hgage + ancob3+ hhtype+ jbocct + I(log(wsfei)), data=xsub)
summary(fit)
#fit <- clm(jbmssec ~ hgsex + hgage + ancob3+ hhtype+ jbocct + wages_perc + hhstate, data=xsub)
#summary(fit)
#Model is nearly unidentifiable
#fit <- clm(jbmssec ~ hgsex + hgage + ancob3+ hhtype+ jbocct+ edcoq + hhstate, data=xsub)
```

##### wages_perc

```{r satisfaction_job_security_perc, eval=T, include=T, echo=F, comment=NA, cache=F}
library(ordinal)
fit <- clm(jbmssec ~ hgsex + hgage + ancob3+ hhtype+ jbocct + wages_perc, data=xsub)
summary(fit)
```

No problems with this fit. wages_perc works better than wsfei to explain job satisfaction.


##### Smoothing satisfaction job security

We now create three variables: the wage (or wage_perc) for Australians, English-speaking migrants and other migrants.
We fit a generalized additive model with the effect of these three variable smoothed.

```{r vgam4, eval=T, include=T, echo=F, comment=NA}
library(VGAM)
#fitgam0 <- vgam(jbmssec ~ hgsex + hgage + ancob3+ hhtype+ jbocct + s(wages_perc), data=xsub, family=propodds)
#plotvgam(fitgam0, rugplot=F)

##wage
fitgam_wage <- vgam(jbmssec ~ hgsex + hgage + hhtype+ jbocct + s(w_au) + s(w_anglo) + s(w_others), data=xsub, family=propodds)
plotvgam(fitgam_wage, se=T, rugplot=F, xlab="wage percentiles", ylab="effect on satisfaction", which.term=c("s(w_au)"),control=plotvgam.control(ylim=c(-.2,.4), lcol="blue", scol="blue"))
plotvgam(fitgam_wage, se=T, rugplot=F, which.term=c("s(w_anglo)"),control=plotvgam.control(add.arg=T, lcol="red", scol="red"))
plotvgam(fitgam_wage, se=T, rugplot=F, which.term=c("s(w_others)"),control=plotvgam.control(add.arg=T, lcol="black", scol="black"))
legend("bottomright",c("Australians", "English-speaking migrants", "Other migrants") , col=c("blue","red","black"), lty=c(1,1,1) )
```

The confidence intervals are too big, the wage is not the right variable to use.
We can now use the percentiles of wage in each job code.

```{r vgam5, eval=T, include=T, echo=F, comment=NA}
##wage_perc
fitgam <- vgam(jbmssec ~ hgsex + hgage + hhtype+ jbocct + s(wp_au) + s(wp_anglo) + s(wp_others), data=xsub, family=propodds)
dev.off()
plotvgam(fitgam, rugplot=F, se=T, xlab="wage percentiles", ylab="effect on satisfaction", which.term=c("s(wp_au)"),control=plotvgam.control(ylim=c(-.3,.5), lcol="blue", scol="blue"))
plotvgam(fitgam, rugplot=F, se=T, which.term=c("s(wp_anglo)"),control=plotvgam.control(add.arg=T, lcol="red", scol="red"))
plotvgam(fitgam, rugplot=F, se=T, which.term=c("s(wp_others)"),control=plotvgam.control(add.arg=T, lcol="black", scol="black"))
legend("bottomright",c("Australians", "English-speaking migrants", "Other migrants") , col=c("blue","red","black"), lty=c(1,1,1) )
```

The results are interesting: [interpretation here].
Let's now study the satisfaction for pay as function of yearssince studying:

```{r vgam6, eval=T, include=T, echo=F, comment=NA}
fitgam <- vgam(jbmssec ~ hgsex + hgage + hhtype+ jbocct + s(wages_perc) + s(ehtse_au) + s(ehtse_anglo) + s(ehtse_others), data=xsub, family=propodds)
#Wages_perc
plotvgam(fitgam, rugplot=F, se=T, xlab="wage percentiles", ylab="effect on satisfaction", which.term=c("s(wages_perc)"),control=plotvgam.control(ylim=c(-.3,1), lcol="blue", scol="black"))
#Years since studying
plotvgam(fitgam, rugplot=F, se=F, xlab="Years since studying", ylab="effect on satisfaction", which.term=c("s(ehtse_au)"),control=plotvgam.control(ylim=c(-1,1), lcol="blue", scol="blue"))
plotvgam(fitgam, rugplot=F, se=F, which.term=c("s(ehtse_anglo)"),control=plotvgam.control(add.arg=T, lcol="red", scol="red"))
plotvgam(fitgam, rugplot=F, se=F, which.term=c("s(ehtse_others)"),control=plotvgam.control(add.arg=T, lcol="black", scol="black"))
legend("bottomright",c("Australians", "English-speaking migrants", "Other migrants") , col=c("blue","red","black"), lty=c(1,1,1) )
```



## Differences
TODO

```{r eval=F, include=T, echo=F, comment=NA}
d=deltapay=by(x, x$xwaveid, function(x){n=nrow(x);return(x$wsfei[2:n]/x$wsfei[1:(n-1)])})
plot(log(d[[1]]), xlim=c(0,12),ylim=c(0.1,20), xlab='wave', ylab='log(annual salary)')
for (i in 2:length(d)) {
  if (!is.null(d[[i]])){
    if (all(!is.na(d[[i]]))) {
      points(log(d[[i]]))
    }
  }
}

d=deltaperc=by(x, x$xwaveid, function(x){n=nrow(x);return(x$wages_perc[2:n]-x$wages_perc[1:(n-1)])})
plot(log(d[[1]]), xlim=c(0,12),ylim=c(0,1), xlab='wave', ylab='wages_perc')
for (i in 2:length(d)) {
  if (!is.null(d[[i]])){
    if (all(!is.na(d[[i]]))) {
      points(d[[i]])
    }
  }
}

```


































